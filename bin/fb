#!/usr/bin/env node
var fs = require('fs');
var argv = require('optimist')
	.demand(1)
	.argv;
var fb = require('../lib/');
var getRoot = require('../lib/getRoot');
var App = require('../lib/app')

function cb_all(err) {
	if(err) {
		console.log(err.message);
		console.log('fail');
		process.exit(1);
	}
	console.log('success');
	process.exit(0);
}

getRoot(function (err, app) {
	if (err) {
		console.log(err);
		process.exit(1);
	}

	if (argv._[0] === 'init' && root) {
		console.log('已经是一个工作目录了');
		process.exit(2);
	}

	switch(argv._[0]) {
		case 'init':
			App.init(process.cwd(), cb_all);
			break;

		case 'add':
			App.add(argv._[1], root, cb_all);
			break;

		case 'ver':
		case 'version':
			argv = require('optimist')
				.string('_')
				.argv

			fb.version(argv, root, cb_all);
			break;

		case 'build':
			argv = require('optimist')
				.string('v')
				.string('t')
				.alias('t', 'timestamp')
				.alias('v', 'version')
				.argv

			var page = argv._.length >= 2 ? { name: argv._[1] } : root.page,
		        rootdir = root.dir;
		    

		    if (!page) {
		        console.log('No page given!');
		        process.exit(2);
		    }

		    if (argv.version) {
		        page.version = argv.version;
		    }

		    if (argv.timestamp) {
		        page.timestamp = argv.timestamp;
		    }

		    root.page = page;

			fb.build(root, cb_all);
	}
});
